                              1 ;--------------------------------------------------------
                              2 ; File Created by SDCC : free open source ANSI-C Compiler
                              3 ; Version 4.0.0 #11528 (MINGW32)
                              4 ;--------------------------------------------------------
                              5 	.module OAMManager
                              6 	.optsdcc -mgbz80
                              7 	
                              8 ;--------------------------------------------------------
                              9 ; Public variables in this module
                             10 ;--------------------------------------------------------
                             11 	.globl _set_sprite_data
                             12 	.globl _next_oam_sprite_flags
                             13 	.globl _next_oam_sprite_idx
                             14 	.globl _next_oam_sprite_x
                             15 	.globl _next_oam_sprite_y
                             16 	.globl _oam_end
                             17 	.globl _oam1
                             18 	.globl _oam0
                             19 	.globl _oam
                             20 	.globl _oam_mirror
                             21 	.globl _sprites_pal
                             22 	.globl _last_sprite_loaded
                             23 	.globl _LoadSprite
                             24 	.globl _SwapOAMs
                             25 	.globl _ClearOAMs
                             26 	.globl _FlushOAMSprite
                             27 ;--------------------------------------------------------
                             28 ; special function registers
                             29 ;--------------------------------------------------------
                             30 ;--------------------------------------------------------
                             31 ; ram data
                             32 ;--------------------------------------------------------
                             33 	.area _DATA
   0000                      34 _last_sprite_loaded::
   0000                      35 	.ds 1
   0001                      36 _sprites_pal::
   0001                      37 	.ds 256
                     DF00    38 _oam_mirror	=	0xdf00
   0101                      39 _oam::
   0101                      40 	.ds 2
   0103                      41 _oam0::
   0103                      42 	.ds 2
   0105                      43 _oam1::
   0105                      44 	.ds 2
   0107                      45 _oam_end::
   0107                      46 	.ds 2
   0109                      47 _next_oam_sprite_y::
   0109                      48 	.ds 1
   010A                      49 _next_oam_sprite_x::
   010A                      50 	.ds 1
   010B                      51 _next_oam_sprite_idx::
   010B                      52 	.ds 1
   010C                      53 _next_oam_sprite_flags::
   010C                      54 	.ds 1
                             55 ;--------------------------------------------------------
                             56 ; absolute external ram data
                             57 ;--------------------------------------------------------
                             58 	.area _DABS (ABS)
                             59 ;--------------------------------------------------------
                             60 ; global & static initialisations
                             61 ;--------------------------------------------------------
                             62 	.area _HOME
                             63 	.area _GSINIT
                             64 	.area _GSFINAL
                             65 	.area _GSINIT
                             66 ;C:/GB/ZGB/common/src/OAMManager.c:4: UINT8 last_sprite_loaded = 0;
   0000 21r00r00             67 	ld	hl, #_last_sprite_loaded
   0003 36 00                68 	ld	(hl), #0x00
                             69 ;C:/GB/ZGB/common/src/OAMManager.c:36: UINT8* oam  = (UINT8*)0xC000;
   0005 21r01r01             70 	ld	hl, #_oam
   0008 36 00                71 	ld	(hl), #0x00
   000A 23                   72 	inc	hl
   000B 36 C0                73 	ld	(hl), #0xc0
                             74 ;C:/GB/ZGB/common/src/OAMManager.c:37: UINT8* oam0 = (UINT8*)0xC000;
   000D 21r03r01             75 	ld	hl, #_oam0
   0010 36 00                76 	ld	(hl), #0x00
   0012 23                   77 	inc	hl
   0013 36 C0                78 	ld	(hl), #0xc0
                             79 ;C:/GB/ZGB/common/src/OAMManager.c:38: UINT8* oam1 = (UINT8*)OAM_MIRROR_ADDRESS;
   0015 21r05r01             80 	ld	hl, #_oam1
   0018 36 00                81 	ld	(hl), #0x00
   001A 23                   82 	inc	hl
   001B 36 DF                83 	ld	(hl), #0xdf
                             84 ;C:/GB/ZGB/common/src/OAMManager.c:39: UINT8* oam_end = (UINT8*)0xC000;
   001D 21r07r01             85 	ld	hl, #_oam_end
   0020 36 00                86 	ld	(hl), #0x00
   0022 23                   87 	inc	hl
   0023 36 C0                88 	ld	(hl), #0xc0
                             89 ;--------------------------------------------------------
                             90 ; Home
                             91 ;--------------------------------------------------------
                             92 	.area _HOME
                             93 	.area _HOME
                             94 ;--------------------------------------------------------
                             95 ; code
                             96 ;--------------------------------------------------------
                             97 	.area _CODE
                             98 ;C:/GB/ZGB/common/src/OAMManager.c:7: UINT8 LoadSprite(struct TilesInfoInternal* data) {
                             99 ;	---------------------------------
                            100 ; Function LoadSprite
                            101 ; ---------------------------------
   0000                     102 _LoadSprite::
   0000 E8 F8               103 	add	sp, #-8
                            104 ;C:/GB/ZGB/common/src/OAMManager.c:9: UINT8* sprites_pal_ptr = &sprites_pal[last_sprite_loaded];
   0002 01r01r00            105 	ld	bc, #_sprites_pal+0
   0005 79                  106 	ld	a, c
   0006 21r00r00            107 	ld	hl, #_last_sprite_loaded
   0009 86                  108 	add	a, (hl)
   000A 4F                  109 	ld	c, a
   000B 30 01               110 	jr	NC,00126$
   000D 04                  111 	inc	b
   000E                     112 00126$:
   000E F8 06               113 	ldhl	sp,	#6
   0010 71                  114 	ld	(hl), c
   0011 23                  115 	inc	hl
   0012 70                  116 	ld	(hl), b
                            117 ;C:/GB/ZGB/common/src/OAMManager.c:10: UINT8 frame_size = data->width >> 3;
   0013 F8 0A               118 	ldhl	sp,	#10
   0015 2A                  119 	ld	a, (hl+)
   0016 5E                  120 	ld	e, (hl)
   0017 F8 00               121 	ldhl	sp,	#0
   0019 22                  122 	ld	(hl+), a
   001A 73                  123 	ld	(hl), e
   001B D1                  124 	pop	de
   001C D5                  125 	push	de
   001D 1A                  126 	ld	a,(de)
   001E CB 37               127 	swap	a
   0020 07                  128 	rlca
   0021 E6 1F               129 	and	a, #0x1f
   0023 23                  130 	inc	hl
   0024 77                  131 	ld	(hl), a
                            132 ;C:/GB/ZGB/common/src/OAMManager.c:11: UINT8 n_tiles = data->num_frames << frame_size;
   0025 C1                  133 	pop	bc
   0026 C5                  134 	push	bc
   0027 03                  135 	inc	bc
   0028 03                  136 	inc	bc
   0029 0A                  137 	ld	a, (bc)
   002A 4F                  138 	ld	c, a
   002B 7E                  139 	ld	a, (hl)
   002C 3C                  140 	inc	a
   002D 18 02               141 	jr	00128$
   002F                     142 00127$:
   002F CB 21               143 	sla	c
   0031                     144 00128$:
   0031 3D                  145 	dec	a
   0032 20 FB               146 	jr	NZ,00127$
   0034 23                  147 	inc	hl
   0035 71                  148 	ld	(hl), c
                            149 ;C:/GB/ZGB/common/src/OAMManager.c:12: UINT8* palette_idx = data->color_data;
   0036 D1                  150 	pop	de
   0037 D5                  151 	push	de
   0038 21 05 00            152 	ld	hl, #0x0005
   003B 19                  153 	add	hl, de
   003C 4D                  154 	ld	c, l
   003D 44                  155 	ld	b, h
   003E 59                  156 	ld	e, c
   003F 50                  157 	ld	d, b
   0040 1A                  158 	ld	a,(de)
   0041 F8 04               159 	ldhl	sp,	#4
   0043 22                  160 	ld	(hl+), a
   0044 13                  161 	inc	de
   0045 1A                  162 	ld	a, (de)
   0046 77                  163 	ld	(hl), a
                            164 ;C:/GB/ZGB/common/src/OAMManager.c:14: set_sprite_data(last_sprite_loaded, n_tiles, data->data);
   0047 C1                  165 	pop	bc
   0048 C5                  166 	push	bc
   0049 03                  167 	inc	bc
   004A 03                  168 	inc	bc
   004B 03                  169 	inc	bc
   004C 69                  170 	ld	l, c
   004D 60                  171 	ld	h, b
   004E 4E                  172 	ld	c, (hl)
   004F 23                  173 	inc	hl
   0050 46                  174 	ld	b, (hl)
   0051 C5                  175 	push	bc
   0052 F8 05               176 	ldhl	sp,	#5
   0054 7E                  177 	ld	a, (hl)
   0055 F5                  178 	push	af
   0056 33                  179 	inc	sp
   0057 21r00r00            180 	ld	hl, #_last_sprite_loaded
   005A 7E                  181 	ld	a, (hl)
   005B F5                  182 	push	af
   005C 33                  183 	inc	sp
   005D CDr00r00            184 	call	_set_sprite_data
   0060 E8 04               185 	add	sp, #4
                            186 ;C:/GB/ZGB/common/src/OAMManager.c:15: last_sprite_loaded += n_tiles;
   0062 21r00r00            187 	ld	hl, #_last_sprite_loaded
   0065 7E                  188 	ld	a, (hl)
   0066 F8 03               189 	ldhl	sp,	#3
   0068 86                  190 	add	a, (hl)
   0069 21r00r00            191 	ld	hl, #_last_sprite_loaded
   006C 77                  192 	ld	(hl), a
                            193 ;C:/GB/ZGB/common/src/OAMManager.c:17: for(i = 0; i != n_tiles; ++i, sprites_pal_ptr ++) {
   006D 0E 00               194 	ld	c, #0x00
   006F                     195 00106$:
   006F F8 03               196 	ldhl	sp,	#3
   0071 7E                  197 	ld	a, (hl)
   0072 91                  198 	sub	a, c
   0073 CArB1r00            199 	jp	Z,00104$
                            200 ;C:/GB/ZGB/common/src/OAMManager.c:18: if(palette_idx)
   0076 F8 05               201 	ldhl	sp,	#5
   0078 3A                  202 	ld	a, (hl-)
   0079 B6                  203 	or	a, (hl)
   007A 28 22               204 	jr	Z,00102$
                            205 ;C:/GB/ZGB/common/src/OAMManager.c:19: *sprites_pal_ptr = *(palette_idx + (i >> frame_size)); 
   007C 2B                  206 	dec	hl
   007D 2B                  207 	dec	hl
   007E 7E                  208 	ld	a, (hl)
   007F F5                  209 	push	af
   0080 41                  210 	ld	b, c
   0081 F1                  211 	pop	af
   0082 3C                  212 	inc	a
   0083 18 02               213 	jr	00131$
   0085                     214 00130$:
   0085 CB 38               215 	srl	b
   0087                     216 00131$:
   0087 3D                  217 	dec	a
   0088 20 FB               218 	jr	NZ, 00130$
   008A 58                  219 	ld	e, b
   008B 16 00               220 	ld	d, #0x00
   008D F8 04               221 	ldhl	sp,	#4
   008F 2A                  222 	ld	a, (hl+)
   0090 66                  223 	ld	h, (hl)
   0091 6F                  224 	ld	l, a
   0092 19                  225 	add	hl, de
   0093 45                  226 	ld	b,l
   0094 7C                  227 	ld	a,h
   0095 46                  228 	ld	b, (hl)
   0096 F8 06               229 	ldhl	sp,	#6
   0098 2A                  230 	ld	a, (hl+)
   0099 66                  231 	ld	h, (hl)
   009A 6F                  232 	ld	l, a
   009B 70                  233 	ld	(hl), b
   009C 18 07               234 	jr	00107$
   009E                     235 00102$:
                            236 ;C:/GB/ZGB/common/src/OAMManager.c:21: *sprites_pal_ptr = 0; 
   009E F8 06               237 	ldhl	sp,	#6
   00A0 2A                  238 	ld	a, (hl+)
   00A1 66                  239 	ld	h, (hl)
   00A2 6F                  240 	ld	l, a
   00A3 36 00               241 	ld	(hl), #0x00
   00A5                     242 00107$:
                            243 ;C:/GB/ZGB/common/src/OAMManager.c:17: for(i = 0; i != n_tiles; ++i, sprites_pal_ptr ++) {
   00A5 0C                  244 	inc	c
   00A6 F8 06               245 	ldhl	sp,	#6
   00A8 34                  246 	inc	(hl)
   00A9 C2r6Fr00            247 	jp	NZ,00106$
   00AC 23                  248 	inc	hl
   00AD 34                  249 	inc	(hl)
   00AE C3r6Fr00            250 	jp	00106$
   00B1                     251 00104$:
                            252 ;C:/GB/ZGB/common/src/OAMManager.c:24: return last_sprite_loaded - n_tiles;
   00B1 21r00r00            253 	ld	hl, #_last_sprite_loaded
   00B4 7E                  254 	ld	a, (hl)
   00B5 F8 03               255 	ldhl	sp,	#3
   00B7 96                  256 	sub	a, (hl)
   00B8 5F                  257 	ld	e, a
                            258 ;C:/GB/ZGB/common/src/OAMManager.c:25: }
   00B9 E8 08               259 	add	sp, #8
   00BB C9                  260 	ret
                            261 ;C:/GB/ZGB/common/src/OAMManager.c:40: void SwapOAMs() {
                            262 ;	---------------------------------
                            263 ; Function SwapOAMs
                            264 ; ---------------------------------
   00BC                     265 _SwapOAMs::
                            266 ;C:/GB/ZGB/common/src/OAMManager.c:42: UINT8* tmp = oam;
   00BC 21r02r01            267 	ld	hl, #_oam + 1
   00BF 2B                  268 	dec	hl
   00C0 4E                  269 	ld	c, (hl)
   00C1 23                  270 	inc	hl
   00C2 46                  271 	ld	b, (hl)
                            272 ;C:/GB/ZGB/common/src/OAMManager.c:43: while(oam < oam_end) {
   00C3                     273 00101$:
   00C3 11r01r01            274 	ld	de, #_oam
   00C6 21r07r01            275 	ld	hl, #_oam_end
   00C9 1A                  276 	ld	a, (de)
   00CA 96                  277 	sub	a, (hl)
   00CB 23                  278 	inc	hl
   00CC 13                  279 	inc	de
   00CD 1A                  280 	ld	a, (de)
   00CE 9E                  281 	sbc	a, (hl)
   00CF 30 15               282 	jr	NC,00103$
                            283 ;C:/GB/ZGB/common/src/OAMManager.c:44: *oam = 200;
   00D1 21r02r01            284 	ld	hl, #_oam + 1
   00D4 2B                  285 	dec	hl
   00D5 5E                  286 	ld	e, (hl)
   00D6 23                  287 	inc	hl
   00D7 56                  288 	ld	d, (hl)
   00D8 3E C8               289 	ld	a, #0xc8
   00DA 12                  290 	ld	(de), a
                            291 ;C:/GB/ZGB/common/src/OAMManager.c:45: oam += 4;
   00DB 2B                  292 	dec	hl
   00DC 7E                  293 	ld	a, (hl)
   00DD C6 04               294 	add	a, #0x04
   00DF 22                  295 	ld	(hl+), a
   00E0 7E                  296 	ld	a, (hl)
   00E1 CE 00               297 	adc	a, #0x00
   00E3 77                  298 	ld	(hl), a
   00E4 18 DD               299 	jr	00101$
   00E6                     300 00103$:
                            301 ;C:/GB/ZGB/common/src/OAMManager.c:48: if((0xFF00 & (UINT16)oam) == 0xC000) {
   00E6 21r02r01            302 	ld	hl, #_oam + 1
   00E9 2B                  303 	dec	hl
   00EA 5E                  304 	ld	e, (hl)
   00EB 23                  305 	inc	hl
   00EC 56                  306 	ld	d, (hl)
   00ED 1E 00               307 	ld	e, #0x00
   00EF 7B                  308 	ld	a, e
   00F0 B7                  309 	or	a, a
   00F1 20 23               310 	jr	NZ,00105$
   00F3 7A                  311 	ld	a, d
   00F4 D6 C0               312 	sub	a, #0xc0
   00F6 20 1E               313 	jr	NZ,00105$
                            314 ;C:/GB/ZGB/common/src/OAMManager.c:49: *(UINT8*)0xFF81 = 0xC0;
   00F8 21 81 FF            315 	ld	hl, #0xff81
   00FB 36 C0               316 	ld	(hl), #0xc0
                            317 ;C:/GB/ZGB/common/src/OAMManager.c:50: oam0 = tmp;
   00FD 21r03r01            318 	ld	hl, #_oam0
   0100 71                  319 	ld	(hl), c
   0101 23                  320 	inc	hl
   0102 70                  321 	ld	(hl), b
                            322 ;C:/GB/ZGB/common/src/OAMManager.c:51: oam = (UINT8*)OAM_MIRROR_ADDRESS;
   0103 21r01r01            323 	ld	hl, #_oam
   0106 36 00               324 	ld	(hl), #0x00
   0108 23                  325 	inc	hl
   0109 36 DF               326 	ld	(hl), #0xdf
                            327 ;C:/GB/ZGB/common/src/OAMManager.c:52: oam_end = oam1;
   010B 21r05r01            328 	ld	hl, #_oam1
   010E 2A                  329 	ld	a, (hl+)
   010F 5E                  330 	ld	e, (hl)
   0110 21r07r01            331 	ld	hl, #_oam_end
   0113 22                  332 	ld	(hl+), a
   0114 73                  333 	ld	(hl), e
   0115 C9                  334 	ret
   0116                     335 00105$:
                            336 ;C:/GB/ZGB/common/src/OAMManager.c:54: *(UINT8*)0xFF81 = OAM_MIRROR_ADDRESS_HI;
   0116 21 81 FF            337 	ld	hl, #0xff81
   0119 36 DF               338 	ld	(hl), #0xdf
                            339 ;C:/GB/ZGB/common/src/OAMManager.c:55: oam1 = tmp;
   011B 21r05r01            340 	ld	hl, #_oam1
   011E 71                  341 	ld	(hl), c
   011F 23                  342 	inc	hl
   0120 70                  343 	ld	(hl), b
                            344 ;C:/GB/ZGB/common/src/OAMManager.c:56: oam = (UINT8*)0xC000;
   0121 21r01r01            345 	ld	hl, #_oam
   0124 36 00               346 	ld	(hl), #0x00
   0126 23                  347 	inc	hl
   0127 36 C0               348 	ld	(hl), #0xc0
                            349 ;C:/GB/ZGB/common/src/OAMManager.c:57: oam_end = oam0;
   0129 21r03r01            350 	ld	hl, #_oam0
   012C 2A                  351 	ld	a, (hl+)
   012D 5E                  352 	ld	e, (hl)
   012E 21r07r01            353 	ld	hl, #_oam_end
   0131 22                  354 	ld	(hl+), a
   0132 73                  355 	ld	(hl), e
                            356 ;C:/GB/ZGB/common/src/OAMManager.c:59: }
   0133 C9                  357 	ret
                            358 ;C:/GB/ZGB/common/src/OAMManager.c:61: void ClearOAMs() {
                            359 ;	---------------------------------
                            360 ; Function ClearOAMs
                            361 ; ---------------------------------
   0134                     362 _ClearOAMs::
                            363 ;C:/GB/ZGB/common/src/OAMManager.c:63: oam0 = (UINT8*)0xC000;
   0134 21r03r01            364 	ld	hl, #_oam0
   0137 36 00               365 	ld	(hl), #0x00
   0139 23                  366 	inc	hl
   013A 36 C0               367 	ld	(hl), #0xc0
                            368 ;C:/GB/ZGB/common/src/OAMManager.c:64: oam1 = (UINT8*)OAM_MIRROR_ADDRESS;
   013C 21r05r01            369 	ld	hl, #_oam1
   013F 36 00               370 	ld	(hl), #0x00
   0141 23                  371 	inc	hl
   0142 36 DF               372 	ld	(hl), #0xdf
                            373 ;C:/GB/ZGB/common/src/OAMManager.c:65: for(i = 0; i < 40; ++i, oam0 += 4, oam1 += 4) {
   0144 0E 00               374 	ld	c, #0x00
   0146                     375 00102$:
                            376 ;C:/GB/ZGB/common/src/OAMManager.c:66: *oam0 = 200;
   0146 21r04r01            377 	ld	hl, #_oam0 + 1
   0149 2B                  378 	dec	hl
   014A 5E                  379 	ld	e, (hl)
   014B 23                  380 	inc	hl
   014C 56                  381 	ld	d, (hl)
   014D 3E C8               382 	ld	a, #0xc8
   014F 12                  383 	ld	(de), a
                            384 ;C:/GB/ZGB/common/src/OAMManager.c:67: *oam1 = 200;
   0150 21r06r01            385 	ld	hl, #_oam1 + 1
   0153 2B                  386 	dec	hl
   0154 5E                  387 	ld	e, (hl)
   0155 23                  388 	inc	hl
   0156 56                  389 	ld	d, (hl)
   0157 3E C8               390 	ld	a, #0xc8
   0159 12                  391 	ld	(de), a
                            392 ;C:/GB/ZGB/common/src/OAMManager.c:65: for(i = 0; i < 40; ++i, oam0 += 4, oam1 += 4) {
   015A 0C                  393 	inc	c
   015B 21r03r01            394 	ld	hl, #_oam0
   015E 7E                  395 	ld	a, (hl)
   015F C6 04               396 	add	a, #0x04
   0161 22                  397 	ld	(hl+), a
   0162 7E                  398 	ld	a, (hl)
   0163 CE 00               399 	adc	a, #0x00
   0165 77                  400 	ld	(hl), a
   0166 21r05r01            401 	ld	hl, #_oam1
   0169 7E                  402 	ld	a, (hl)
   016A C6 04               403 	add	a, #0x04
   016C 22                  404 	ld	(hl+), a
   016D 7E                  405 	ld	a, (hl)
   016E CE 00               406 	adc	a, #0x00
   0170 77                  407 	ld	(hl), a
   0171 79                  408 	ld	a, c
   0172 D6 28               409 	sub	a, #0x28
   0174 DAr46r01            410 	jp	C, 00102$
                            411 ;C:/GB/ZGB/common/src/OAMManager.c:69: }
   0177 C9                  412 	ret
                            413 ;C:/GB/ZGB/common/src/OAMManager.c:75: void FlushOAMSprite() {
                            414 ;	---------------------------------
                            415 ; Function FlushOAMSprite
                            416 ; ---------------------------------
   0178                     417 _FlushOAMSprite::
                            418 ;C:/GB/ZGB/common/src/OAMManager.c:103: __endasm;
                            419 ;store	in bc the address stored in oam ptr
   0178 21r01r01            420 	ld	hl,#_oam
   017B 4E                  421 	ld	c,(hl)
   017C 23                  422 	inc	hl
   017D 46                  423 	ld	b,(hl)
                            424 ;store	in hl the beginning of data (pointer to first param)
   017E 21r09r01            425 	ld	hl, #_next_oam_sprite_y
                            426 ;OAMManager.c:35:	*(oam ++) = y;
   0181 2A                  427 	ld	a,(hl+)
   0182 02                  428 	ld	(bc),a
   0183 0C                  429 	inc	c
                            430 ;OAMManager.c:36:	*(oam ++) = x;
   0184 2A                  431 	ld	a,(hl+)
   0185 02                  432 	ld	(bc),a
   0186 0C                  433 	inc	c
                            434 ;OAMManager.c:37:	*(oam ++) = idx;
   0187 2A                  435 	ld	a,(hl+)
   0188 02                  436 	ld	(bc),a
   0189 0C                  437 	inc	c
                            438 ;OAMManager.c:38:	*(oam ++) = flags;
   018A 2A                  439 	ld	a,(hl+)
   018B 02                  440 	ld	(bc),a
   018C 0C                  441 	inc	c
                            442 ;refresh	oam value
   018D 21r01r01            443 	ld	hl,#_oam
   0190 71                  444 	ld	(hl), c
                            445 ;C:/GB/ZGB/common/src/OAMManager.c:104: }
   0191 C9                  446 	ret
                            447 	.area _CODE
                            448 	.area _CABS (ABS)
